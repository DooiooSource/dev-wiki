/*! 2014-10-11 */

"use strict";angular.module("dwikiApp",["ngCookies","ngResource","ngSanitize","ngRoute"]).config(function(a,b,c){a.when("/",{templateUrl:"partials/main",controller:"MainCtrl"}).when("/login",{templateUrl:"partials/login",controller:"LoginCtrl"}).when("/signup",{templateUrl:"partials/signup",controller:"SignupCtrl"}).when("/settings",{templateUrl:"partials/settings",controller:"SettingsCtrl"}).when("/article/:id",{templateUrl:"partials/article",controller:"ArticleCtrl"}).when("/article/:id/edit",{templateUrl:"partials/new",controller:"EditCtrl",authenticate:!0}).when("/category/:category",{templateUrl:"partials/category",controller:"CategoryCtrl"}).when("/people/:empNo",{templateUrl:"partials/people",controller:"PeopleCtrl"}).when("/new",{templateUrl:"partials/new",controller:"NewCtrl",authenticate:!0}).when("/dui",{templateUrl:"partials/dui",controller:"DuiCtrl"}).when("/doc/:name",{templateUrl:"partials/doc",controller:"DocCtrl"}).when("/search",{templateUrl:"partials/search",controller:"SearchCtrl"}).otherwise({redirectTo:"/"}),b.html5Mode(!0),c.interceptors.push(["$q","$location",function(a,b){return{responseError:function(c){return 401===c.status?(b.path("/login"),a.reject(c)):a.reject(c)}}}])}).run(function(a,b,c,d){a.$on("$routeChangeStart",function(b,e){a.currentCategory="",e.authenticate&&!d.isLoggedIn()&&c.path("/login")}),b.get("/api/category",{cache:!0}).success(function(b){a.categories=b})}),angular.module("dwikiApp").factory("Auth",function(a,b,c,d,e,f){function g(a){for(var b=a+"=",c=document.cookie.split(";"),d=0;d<c.length;d++){var e=c[d].trim();if(0==e.indexOf(b))return e.substring(b.length,e.length)}return""}var h=g("user");return h&&(b.currentUser=JSON.parse(decodeURIComponent(h)),f.remove("user")),{login:function(a,c){var e=c||angular.noop;return d.save({empNo:a.empNo,password:a.password},function(a){return b.currentUser=a,e()},function(a){return e(a)}).$promise},logout:function(a){var c=a||angular.noop;return d.delete(function(){return b.currentUser=null,c()},function(a){return c(a)}).$promise},currentUser:function(){return e.get()},isLoggedIn:function(){var a=b.currentUser;return!!a}}}),angular.module("dwikiApp").factory("Session",function(a){return a("/api/session/")}),angular.module("dwikiApp").factory("User",function(a){return a("/api/users/:id",{id:"@id"},{update:{method:"PUT",params:{}},get:{method:"GET",params:{id:"me"}}})}),angular.module("dwikiApp").controller("ArticleCtrl",function(a,b,c,d,e,f,g){c.get("/api/showArticle/"+d.id).success(function(c){c.html=e.trustAsHtml(c.html),a.article=c,b.currentCategory=c.category}),f(function(){hljs.configure({tabReplace:"    "}),$("pre").each(function(a,b){hljs.highlightBlock(b)}),$("#toc").tocPlugin({selector:"h1,h2,h3,h4",container:".mdbody",scrollToOffset:100})},250),a.deleteArticle=function(){confirm("文章删除后无法恢复，您确定要删除该文章吗？")&&c.delete("/api/article/"+d.id).success(function(a){"ok"==a.status?g.path("/"):alert("删除失败")})},a.commentContent="",a.comment=function(b){a.submitted=!0;var e={articleId:d.id,content:a.commentContent,empNo:a.currentUser.empNo};b.$valid&&c.post("/api/comments",e).success(function(b){"fail"==b.status?alert(b.message):(a.commentContent="",c.get("/api/showArticle/"+d.id).success(function(b){a.article.comments=b.comments}))})},a.scrollTo=function(a){if(a.preventDefault(),"a"===a.target.tagName.toLowerCase()){var b=$(a.target).attr("href"),c=$(b).offset().top;$(window).scrollTop(c)}}}),angular.module("dwikiApp").controller("CategoryCtrl",function(a,b,c,d){b.currentCategory=d.category,b.currentTag=d.tags||"",a.currentPage=d.page||1,c.get("/api/articles",{params:{page:a.currentPage,category:d.category,tags:d.tags}}).success(function(b){b.articles.forEach(function(a){a.comments&&a.comments.length>0&&(a.lastComment=a.comments[a.comments.length-1])}),a.articles=b.articles,console.log(a.articles),a.pageCount=b.pages}),angular.forEach(a.categories,function(b){b.name===d.category&&(a.tags=b.tags)})}),angular.module("dwikiApp").controller("DocCtrl",function(a,b,c,d){a.currentCategory="dui",b.mainlink="http://dui.dooioo.com/public/demonew/"+d.name+"/main.json",b.pluginName="",b.commentContent="",b.comment=function(a){b.submitted=!0;var e={linkTo:d.name,body:b.commentContent,empNo:b.currentUser.empNo};a.$valid&&c.post("/api/feedbacks",e).success(function(a){"fail"==a.status?alert(a.message):(b.commentContent="",c.get("/api/feedbacks?linkTo="+d.name).success(function(a){b.feedbacks=a}))})},c.get("/api/feedbacks?linkTo="+d.name).success(function(a){b.feedbacks=a})}),angular.module("dwikiApp").controller("DuiCtrl",function(a,b,c){a.currentCategory="dui",c.get("http://dui.dooioo.com/public/demonew/main.json").success(function(a){console.log(a)}),b.docs=[{text:"自动完成",link:"autocomplete"},{text:"组织架构树",link:"tree"},{text:"表单验证",link:"validation"},{text:"日期选择控件",link:"datepicker"},{text:"添加删除行",link:"addremove"},{text:"字段编辑组件",link:"dui_edit"},{text:"Tips组件",link:"tips"},{text:"分页指令",link:"pagenation"},{text:"查询过滤器",link:"search_filter"},{text:"checkbox选择框",link:"checkbox"}]}),angular.module("dwikiApp").controller("EditCtrl",function(a,b,c,d){function e(b,c){for(var d={},e=a.categories,f=e.length-1;f>=0;f--)if(c===e[f][b]){d=e[f];break}return d}var f=new Simditor({textarea:$("#htmlEditor"),placeholder:"",pasteImage:!0,toolbar:["title","bold","italic","underline","strikethrough","|","ol","ul","blockquote","code","table","link","image","hr","indent","outdent"],defaultImage:"assets/images/image.png",upload:{url:"/api/upload"},markdown:!0});b.get("/api/article/"+d.id).success(function(b){angular.isArray(b.tags)&&(b.tags=b.tags.join(",")),a.params={title:b.title,html:b.html,category:b.category,tags:b.tags,updatedAt:new Date(b.updatedAt).getTime()},a.cateText=b.category,f.setValue(b.html);var c=e("name",a.params.category);a.showTags(c)}),a.tagList=[],a.$watch("params.category",function(b,c){if(b!==c)for(var d=0;d<a.categories.length;d++){var e=a.categories[d];if(e.name==a.params.category)return void(a.tagList=e.tags)}}),a.setCategory=function(b){a.cateText=b.text,a.params.category=b.name,a.ctags=b.tags,a.params.tags=[],a.showTags(b)},a.showTags=function(b){a.ctags=b.tags},a.setTag=function(b){a.haveTag(b)||a.params.tags.push(b)},a.toggleTag=function(b){var c=a.params.tags.indexOf(b);c>=0?a.params.tags.splice(c,1):a.params.tags.push(b)},a.haveTag=function(b){return a.params.tags.indexOf(b)>=0?!0:!1},a.submit=function(){a.params.html=f.getValue(),b.put("/api/article/"+d.id,a.params).success(function(a){"ok"==a.status?c.path("/article/"+a.articleId):alert(a.message)})}}),angular.module("dwikiApp").controller("LoginCtrl",function(a,b,c){a.user={},a.errors={},a.login=function(d){d.$valid&&b.login({empNo:a.user.empNo,password:a.user.password}).then(function(){c.path("/")},function(){alert("工号或密码错误，请重新输入。")}).catch(function(b){b=b.data,a.errors.other=b.message})}}),angular.module("dwikiApp").controller("MainCtrl",function(a,b,c){c.get("/api/articles").success(function(b){a.articles=b.articles.splice(0,10)}),c.get("http://dui.dooioo.com/public/demonew/main.json").success(function(b){a.docs=b})}),angular.module("dwikiApp").controller("NavbarCtrl",function(a,b,c,d,e,f){c.get("/api/category",{cache:!0}).success(function(a){b.menu=a}),b.logout=function(){f.logout().then(function(){d.path("/")})},b.isActive=function(b){return b==a.currentCategory},b.user={},b.errors={},b.login=function(a){a.$valid&&f.login({empNo:b.user.empNo,password:b.user.password}).then(function(){e.reload()},function(){alert("工号或密码错误，请重新输入。")}).catch(function(a){a=a.data,b.errors.other=a.message})},b.search=function(){b.keyword&&d.path("/search").search("keyword",b.keyword)}}),angular.module("dwikiApp").controller("NewCtrl",function(a,b,c,d,e){a.params={title:"",html:"",category:"",tags:[]},a.tagList=[],a.$watch("params.category",function(b,c){if(b!==c)for(var d=0;d<a.categories.length;d++){var e=a.categories[d];if(e.name==a.params.category)return void(a.tagList=e.tags)}});var f=new Simditor({textarea:$("#htmlEditor"),placeholder:"",pasteImage:!0,toolbar:["title","bold","italic","underline","strikethrough","|","ol","ul","blockquote","code","table","link","image","hr","indent","outdent"],defaultImage:"assets/images/image.png",upload:{url:"/api/upload"},markdown:!0});a.submit=function(){a.params.html=f.getValue(),angular.isString(a.params.tags)&&(a.params.tags=a.params.tags.split(",")),b.post("/api/articles",a.params).success(function(a){"ok"==a.status&&e.path("/article/"+a.articleId)})}}),angular.module("dwikiApp").controller("PeopleCtrl",function(a,b,c){a.currentPage=c.page||1,b.get("/api/people/"+c.empNo,{params:{page:a.currentPage}}).success(function(b){a.articles=b.articles,a.pageCount=b.pages,a.user=b.user})}),angular.module("dwikiApp").controller("SearchCtrl",function(a,b,c,d){a.keyword=d.keyword,a.currentPage=d.page||1,c.get("/api/search",{params:{page:a.currentPage,keyword:a.keyword}}).success(function(b){a.articles=b.articles,a.pageCount=b.pages})}),angular.module("dwikiApp").controller("SettingsCtrl",function(a,b,c,d){d.get("/api/category").success(function(b){a.categoryContent=JSON.stringify(b),console.log(b)}),a.submit=function(){d.put("/api/category",{category:a.categoryContent}).success(function(a){console.log(a)})},a.showPermission=function(){Notification.requestPermission(function(b){if("permission"in Notification||(Notification.permission=b),"granted"===b){var d=new Notification("消息提醒",{icon:"images/logo.png",body:"匡前阳发表了新文章《技术分享排期》，点击查看。"});d.onclick=function(){a.$apply(function(){c.path("/article/53d1f61fcfc3dd0000000044")})}}})}}),angular.module("dwikiApp").controller("SettingsCtrl",function(a,b,c,d){d.get("/api/category").success(function(b){a.categoryContent=JSON.stringify(b),console.log(b)}),a.submit=function(){d.put("/api/category",{category:a.categoryContent}).success(function(a){console.log(a)})}}),angular.module("dwikiApp").controller("SignupCtrl",function(a,b,c){a.user={},a.errors={},a.register=function(d){a.submitted=!0,d.$valid&&b.createUser({name:a.user.name,email:a.user.email,password:a.user.password}).then(function(){c.path("/")}).catch(function(b){b=b.data,a.errors={},angular.forEach(b.errors,function(b,c){d[c].$setValidity("mongoose",!1),a.errors[c]=b.message})})}}),angular.module("dwikiApp").filter("catename",function(a,b){return function(a){var c="请选择类别";return angular.forEach(b.categories,function(b){return b.name==a?(console.log(b.text),void(c=b.text)):void 0}),c}}),angular.module("dwikiApp").filter("surfix",function(){return function(a){var b=a.split("/");return b[b.length-1]}}),angular.module("dwikiApp").directive("demoshow",function(a,b,c){return{restrict:"AE",scope:{mainlink:"=",title:"@"},templateUrl:"partials/demoshow.html",link:function(a){a.initData={currentShow:"demo",currentIndex:"-1"},marked.setOptions({gfm:!0,tables:!0,breaks:!1,pedantic:!1,sanitize:!0,smartLists:!0,smartypants:!1,highlight:function(a){return hljs.highlightAuto(a).value}}),a.mainlink&&c.get(a.mainlink).success(function(c){angular.forEach(c.demoshow,function(a){a.iframeUrl=b.trustAsResourceUrl(a.filelist[0].path)}),a.$parent.pluginName=c.title,a.demoshow=c.demoshow}),a.changeTag=function(a,d,e){d.currentIndex=e,d.currentShow="code",c.get(a.path,{cache:!1}).success(function(c){var e="";e="md"===a.type?marked(c):hljs.highlightAuto(c).value,d.content=b.trustAsHtml(e)})}}}}),angular.module("dwikiApp").directive("dropdown",function(a){return{restrict:"EA",link:function(b,c){var d=null,e=angular.noop;b.$watch("$location.path",function(){e()}),c.parent().bind("click",function(a){a.stopPropagation()}),c.siblings(".cate-panel").find(".glyphicon-remove").bind("click",function(){e()}),c.bind("click",function(b){var f=c===d;b.preventDefault(),b.stopPropagation(),d&&e(),f||c.hasClass("disabled")||c.prop("disabled")||(c.parent().addClass("open"),d=c,e=function(b){b&&(b.preventDefault(),b.stopPropagation()),a.unbind("click",e),c.parent().removeClass("open"),e=angular.noop,d=null},a.bind("click",e))})}}}),angular.module("dwikiApp").directive("editor",function(){return{restrict:"A",require:"?ngModel",link:function(a,b,c,d){a.$watch("params.type",function(c,e){if(c!==e){if("html"!==e)return;var f=new Simditor({textarea:b,placeholder:"输入正文...",pasteImage:!0,toolbar:["title","bold","italic","underline","strikethrough","|","ol","ul","blockquote","code","table","link","image","hr","indent","outdent"],defaultImage:"assets/images/image.png",upload:{url:"/api/upload"}});f.on("valuechanged",function(){a.$apply(function(){d.$setViewValue(f.getValue())})}),d.$render=function(){f.setValue(d.$viewValue||"")}}})}}}),angular.module("dwikiApp").directive("mongooseError",function(){return{restrict:"A",require:"ngModel",link:function(a,b,c,d){b.on("keydown",function(){return d.$setValidity("mongoose",!0)})}}}),angular.module("dwikiApp").directive("pagination",function(a){return{template:'<ul class="pagination"><li ng-class="{\'disabled\': currentPage == 1}"><a href="javascript:;" ng-click="prevPage()">上一页</a></li><li ng-class="{\'active\': page == currentPage}" ng-repeat="page in pages"><a href="javascript:;" ng-click="selectPage(page)">{{page}}</a></li><li ng-class="{\'disabled\': currentPage >= pageCount}"><a href="javascript:;" ng-click="nextPage()">下一页</a></li></ul>',restrict:"E",scope:{pageCount:"=",currentPage:"="},link:function(b){b.$watch("pageCount",function(a){b.pages=[];for(var c=1;a>=c;c++)b.pages.push(c)}),b.selectPage=function(b){a.search("page",b)},b.prevPage=function(){b.currentPage>1&&a.search("page",parseInt(b.currentPage)-1)},b.nextPage=function(){b.currentPage<b.pageCount&&a.search("page",parseInt(b.currentPage)+1)}}}});
//# sourceMappingURL=app/dist/app.min.map.js